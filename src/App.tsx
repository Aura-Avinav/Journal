import { useState, useEffect } from 'react';
import { Layout } from './components/Layout';
import { AuthPage } from './components/AuthPage';
import { HabitGrid } from './components/HabitGrid';
import { AchievementBoard } from './components/AchievementBoard';
import { TodoBoard } from './components/TodoBoard';
import { JournalEditor } from './components/JournalEditor';
import { MetricGraph } from './components/MetricGraph';
import { YearView } from './components/YearView';
import { SettingsView } from './components/SettingsView';
import { getDaysInMonth, differenceInCalendarDays, startOfYear, endOfYear, format } from 'date-fns';
import { useStore } from './hooks/useStore';

import { useDynamicFavicon } from './hooks/useDynamicFavicon';
import { MoodSelector } from './components/MoodSelector';

type ViewState = 'dashboard' | 'journal' | 'achievements' | 'year' | 'settings';

function App() {
  useDynamicFavicon();
  const [view, setView] = useState<ViewState>(() => {
    if (typeof window !== 'undefined') {
      // 1. Check for specific "Start View" preference first
      try {
        const prefs = JSON.parse(localStorage.getItem('ituts_preferences_v1') || '{}');
        if (prefs.startView && prefs.startView !== 'dashboard') {
          return prefs.startView;
        }
      } catch (e) { /* ignore */ }

      // 2. Fallback to "Last Open View"
      const savedView = localStorage.getItem('journal_current_view');
      return (savedView as ViewState) || 'dashboard';
    }
    return 'dashboard';
  });

  useEffect(() => {
    // Don't save 'settings' as the current view to return to, strictly speaking, or maybe yes?
    // For now, keep saving all.
    localStorage.setItem('journal_current_view', view);
  }, [view]);



  const [currentDate, setCurrentDate] = useState(new Date());
  const { data, user } = useStore();

  // Midnight Reset Logic: Check every minute if the day has changed
  useEffect(() => {
    const checkMidnight = () => {
      const now = new Date();
      // Compare day/month/year. If different from 'currentDate' (and 'currentDate' was "today"), update it.
      // Note: We only auto-update if the user was looking at "today".
      // If they were looking at last month, we shouldn't jump them to today suddenly.

      if (now.getDate() !== currentDate.getDate() || now.getMonth() !== currentDate.getMonth()) {
        // Only force update if the view was ostensibly "today" or we just want to ensure "today" is correct logic.
        // Actually, for the MoodSelector to reset, we just need to ensure 'currentDate' reflects 'now' if the user intends it to be today.
        // Let's assume if they are on Dashboard, they usually want Today.

        // But wait, 'currentDate' is also used for navigating months. 
        // If I am looking at "December 2025", I don't want it to jump to "February 2026" at midnight.
        // However, MoodSelector usually uses 'currentDate'.

        // Let's refine: The MoodSelector should arguably use "Today" or the "Selected Date".
        // The user wants "Daily energy... reset after 11:59".
        // This implies they are using it for "Today".

        // Code-wise: 'currentDate' initializes to `new Date()`.
        // If I keep the app open overnight, `currentDate` remains yesterday.
        // So yes, I should update `currentDate` ONLY IF `currentDate` implies "Today" (i.e. it matched the system time previously).

        // Simplification: Check if `currentDate` is effectively "Yesterday" relative to `now`.
        // If so, update it to `now`.

        // Actually, safer: Just check periodically. If `currentDate` < `now` (date-wise) AND user hasn't explicitly navigated back, update.
        // But we don't know if they navigated.

        // Force update strategy:
        // If the day changes, update `currentDate` to the new Today.
        // Note: This might disrupt if viewing history, but ensures the "Reset" requirement is met.
        setCurrentDate(new Date());
      }
    };

    const timer = setInterval(checkMidnight, 60000); // Check every minute
    return () => clearInterval(timer);
  }, [currentDate]);

  // Handle Startup View Preference (Once per session/load)
  useEffect(() => {
    if (user && data.preferences?.startView) {
      const prefView = data.preferences.startView;
      if (view === 'dashboard' && prefView !== 'dashboard') {
        const hasRedirected = sessionStorage.getItem('ituts_start_redirect');
        if (!hasRedirected) {
          setView(prefView);
          sessionStorage.setItem('ituts_start_redirect', 'true');
        }
      }
    }
  }, [user, data.preferences?.startView, view]);

  if (!user) {
    return <AuthPage />;
  }

  const currentMonthName = currentDate.toLocaleString('default', { month: 'long' });
  const currentYear = currentDate.getFullYear();
  // ... rest of component starts ...

  const handleMonthSelect = (date: Date) => {
    setCurrentDate(date);
    setView('dashboard'); // Switch to dashboard to see that month
  };

  const isCurrentYear = new Date().getFullYear() === currentYear && new Date().getMonth() === currentDate.getMonth();

  // Day Count Logic (Still needed for header display)
  const daysInMonth = getDaysInMonth(currentDate);
  const todayDate = new Date().getDate();
  const isCurrentMonth = new Date().getMonth() === currentDate.getMonth() && new Date().getFullYear() === currentDate.getFullYear();
  const isRealCurrentYear = new Date().getFullYear() === currentYear;


  // Progress Calculations
  const calculateProgress = () => {
    const habits = data?.habits || [];
    const currentMonthStr = format(currentDate, 'yyyy-MM');
    // Filter habits: active if they are global OR match the current month
    const activeHabits = habits.filter(h => !h.month || h.month === currentMonthStr);

    if (activeHabits.length === 0) return { monthly: 0, yearly: 0 };

    // Monthly Progress
    let monthlyCompleted = 0;
    const totalPossibleMonthly = activeHabits.length * daysInMonth;

    // Yearly Progress
    let yearlyCompleted = 0;
    const daysElapsedInYear = isRealCurrentYear
      ? differenceInCalendarDays(new Date(), startOfYear(currentDate)) + 1
      : differenceInCalendarDays(endOfYear(currentDate), startOfYear(currentDate)) + 1;
    const totalPossibleYearly = habits.length * daysElapsedInYear;

    // Calculate Monthly Completions (using activeHabits)
    activeHabits.forEach(habit => {
      habit.completedDates.forEach(dateStr => {
        const date = new Date(dateStr);
        if (date.getMonth() === currentDate.getMonth() && date.getFullYear() === currentYear) {
          const isFuture = isCurrentMonth && date.getDate() > todayDate;
          if (!isFuture) {
            monthlyCompleted++;
          }
        }
      });
    });

    // Calculate Yearly Completions (using ALL habits)
    habits.forEach(habit => {
      habit.completedDates.forEach(dateStr => {
        const date = new Date(dateStr);
        if (date.getFullYear() === currentYear) {
          const isFuture = isRealCurrentYear && date > new Date();
          if (!isFuture) {
            yearlyCompleted++;
          }
        }
      });
    });

    return {
      monthly: totalPossibleMonthly > 0 ? Math.min(100, Math.round((monthlyCompleted / totalPossibleMonthly) * 100)) : 0,
      yearly: totalPossibleYearly > 0 ? Math.min(100, Math.round((yearlyCompleted / totalPossibleYearly) * 100)) : 0
    };
  };

  const progress = calculateProgress();

  return (
    <Layout currentView={view} onNavigate={setView} currentDate={currentDate}>
      {view === 'dashboard' ? (
        <div className="space-y-8 pb-10">
          <header className="flex flex-col gap-6 md:flex-row md:items-end justify-between border-b border-surfaceHighlight pb-6">
            <div className="space-y-4 flex-1">
              <div>
                <h1 className="text-3xl md:text-4xl font-bold text-foreground pb-1">
                  {isCurrentYear ? 'Dashboard' : `${currentYear} Overview`}
                </h1>
                <p className="text-secondary text-lg mt-1">
                  {currentMonthName} {currentYear}
                </p>
              </div>

              {!isCurrentYear && (
                <button
                  onClick={() => handleMonthSelect(new Date())}
                  className="text-xs px-3 py-1.5 bg-accent/10 text-accent font-medium rounded-full hover:bg-accent/20 transition-all hover:pr-4 group flex items-center gap-1"
                >
                  <span className="opacity-0 w-0 group-hover:w-auto group-hover:opacity-100 transition-all duration-300">‚Üê</span>
                  Back to Today
                </button>
              )}

              <div className="flex gap-8 max-w-xs">
                <div className="flex-1 space-y-2">
                  <div className="flex justify-between text-xs font-medium text-secondary uppercase tracking-wider">
                    <span>Monthly Progress</span>
                    <span className="text-primary">{progress.monthly}%</span>
                  </div>
                  <div className="h-2 w-full bg-surfaceHighlight rounded-full overflow-hidden">
                    <div
                      className="h-full bg-gradient-to-r from-cyan-500 via-blue-500 to-purple-600 shadow-[0_0_10px_rgba(59,130,246,0.5)] transition-all duration-1000 ease-out"
                      style={{ width: `${progress.monthly}%` }}
                    />
                  </div>
                </div>
              </div>
            </div>

            <div className="flex flex-col items-end gap-2 shrink-0">
              <div className="px-3 py-2 bg-surface/50 rounded-xl border border-surfaceHighlight/50 backdrop-blur-sm text-center">
                <span className="block text-lg font-bold text-foreground font-mono">
                  {isCurrentMonth ? `${todayDate} / ${daysInMonth}` : daysInMonth}
                </span>
                <span className="text-[10px] text-secondary font-medium uppercase tracking-wider">
                  {isCurrentMonth ? 'Day' : 'Total Days'}
                </span>
              </div>
            </div>
          </header>

          {/* Section 1: Protocols (Habits) */}
          <section className="animate-in fade-in slide-in-from-bottom-4 duration-500 delay-100">
            <div className="bg-surface/30 backdrop-blur-md border border-surfaceHighlight rounded-2xl p-4 md:p-6 shadow-xl relative overflow-hidden group">
              <div className="absolute inset-0 bg-gradient-to-br from-primary/5 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-700 pointer-events-none" />
              <HabitGrid date={currentDate} key={`habit-grid-${currentDate.toISOString()}`} />
            </div>
          </section>

          {/* Section 1.5: Mood & Energy (New) */}
          <section className="animate-in fade-in slide-in-from-bottom-4 duration-500 delay-150">
            <div className="bg-surface/30 backdrop-blur-md border border-surfaceHighlight rounded-2xl p-4 md:p-6 shadow-xl">
              <MoodSelector date={currentDate} />
            </div>
          </section>

          {/* Section 2: Achievements & ToDo */}
          <section className="grid grid-cols-1 lg:grid-cols-2 gap-8 animate-in fade-in slide-in-from-bottom-4 duration-500 delay-200">
            <div className="bg-surface/30 backdrop-blur-md border border-surfaceHighlight rounded-2xl p-4 md:p-6 shadow-xl h-full min-h-[400px]">
              <AchievementBoard date={currentDate} key={`achievements-${currentDate.toISOString()}`} />
            </div>
            <div className="bg-surface/30 backdrop-blur-md border border-surfaceHighlight rounded-2xl p-4 md:p-6 shadow-xl h-full min-h-[400px]">
              <TodoBoard />
            </div>
          </section>

          {/* Section 3: Metrics */}
          <section className="animate-in fade-in slide-in-from-bottom-4 duration-500 delay-300">
            <div className="bg-surface/30 backdrop-blur-md border border-surfaceHighlight rounded-2xl p-4 md:p-6 shadow-xl">
              <MetricGraph date={currentDate} key={currentDate.toISOString()} />
            </div>
          </section>
        </div>
      ) : view === 'journal' ? (
        <JournalEditor />
      ) : view === 'year' ? (
        <YearView onSelectMonth={handleMonthSelect} />
      ) : view === 'settings' ? (
        <SettingsView onBack={() => setView('dashboard')} />
      ) : null}
    </Layout>
  );
}

export default App;
